{"version":3,"file":"static/js/2.868056e1c4a3e8cd7458.js","sources":["webpack:///src/components/overview/map/leaflet-map.vue"],"sourcesContent":["<template>\r\n\t<div class=\"ov-module map-module\">\r\n\t\t<div class=\"map-area\">\r\n\t\t\t<div class=\"map-view\">\r\n\t\t\t\t<div id=\"gismap\" ref=\"lMapRef\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"map-control\">\r\n\t\t\t\t<div class=\"mapcontrol\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div\r\n\t\t\t\tclass=\"gisloader\"\r\n\t\t\t\tv-if=\"moduleLoading\"\r\n\t\t\t\tv-loading=\"moduleLoading\"\r\n\t\t\t\telement-loading-text=\"加载中...\"\r\n\t\t\t\telement-loading-spinner=\"el-icon-loading\"\r\n\t\t\t\telement-loading-background=\"rgba(0, 0, 0, 0.2)\"\r\n\t\t\t></div>\r\n\t\t\t<operators-list @getFarmAllPlotEv=\"() => {}\" :gisMapFlag=\"false\" :farmAreaInfo=\"farmAreaInfo\" :dataTargetFlag=\"dataTargetFlag\" :openOperatorList.sync=\"openOperatorList\"></operators-list>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script>\r\n/* global L AMapUI */\r\nimport {getFeature} from '@/common/fn';\r\nexport default {\r\n\tname: 'leaflet-map',\r\n\tprops: {\r\n\t\tdataTargetFlag: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault() {\r\n\t\t\t\treturn 0;\r\n\t\t\t},\r\n\t\t},\r\n\t\tfarmAreaInfo: {\r\n\t\t\ttype: Object,\r\n\t\t\tdefault() {\r\n\t\t\t\treturn areaLevelCorAreaId();\r\n\t\t\t},\r\n\t\t},\r\n\t},\r\n\tdata() {\r\n\t\treturn {\r\n\t\t\tmapLayer: null, // 地图对象\r\n\t\t\tmoduleLoading: false,\r\n\t\t\ttileMapType: JSON.stringify({label: '卫星地图', value: 'weixing'}),\r\n\t\t\ttileMapTypeList: [\r\n\t\t\t\t{label: '标准地图', value: 'landi'},\r\n\t\t\t\t{label: '卫星地图', value: 'weixing'},\r\n\t\t\t],\r\n\t\t\topenOperatorList: false, //是否展开经营主体列表\r\n\t\t};\r\n\t},\r\n\tcreated() {},\r\n\tmounted() {\r\n\t\tthis.$nextTick(async () => {\r\n\t\t\tawait this.renderMap();\r\n\t\t\tawait this.renderMarkersToMap();\r\n\t\t});\r\n\t},\r\n\tmethods: {\r\n\t\t// 获取监管区域下的农场列表---不支持分页\r\n\t\tgetFarmListByArea() {\r\n\t\t\treturn this.$ajax\r\n\t\t\t\t.post(this.$api.operators.listByArea, {\r\n\t\t\t\t\tfarmAreaId: [this.farmAreaInfo.farmAreaId],\r\n\t\t\t\t\tfarmAreaType: this.farmAreaInfo.farmAreaType,\r\n\t\t\t\t\thasBusinessCategoryIdListFlag: 0,\r\n\t\t\t\t})\r\n\t\t\t\t.then(({data}) => {\r\n\t\t\t\t\tif (data.respCode === 0) {\r\n\t\t\t\t\t\treturn data.obj;\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.catch(e => {\r\n\t\t\t\t\tconsole.log(new Error('leaflet'), e);\r\n\t\t\t\t});\r\n\t\t},\r\n\r\n\t\tasync getCenter() {\r\n\t\t\tconst district = await getFeature({\r\n\t\t\t\tareaId: this.farmAreaInfo.farmAreaId,\r\n\t\t\t});\r\n\t\t\treturn district.areaNode._data.geoData.parent.properties.center;\r\n\t\t},\r\n\t\t// 基础的地图图层\r\n\t\tbaseLayerGroup() {\r\n\t\t\treturn L.layerGroup([\r\n\t\t\t\t// 天地图边境线\r\n\t\t\t\tL.tileLayer.chinaProvider('TianDiTu.Realm.Map', {\r\n\t\t\t\t\tid: 'layer_line',\r\n\t\t\t\t\tdetectRetina: false,\r\n\t\t\t\t\tzIndex: 5,\r\n\t\t\t\t\tmaxZoom: 21,\r\n\t\t\t\t\tminZoom: 5,\r\n\t\t\t\t}),\r\n\t\t\t\t// 谷歌卫星图无地名 (与谷歌地名标注资源 二选一)\r\n\t\t\t\tL.tileLayer.chinaProvider('Google.Satellite.Annotion', {\r\n\t\t\t\t\tid: 'layer_google',\r\n\t\t\t\t\tdetectRetina: false,\r\n\t\t\t\t\tzIndex: 3, // 层级越高 越在上面\r\n\t\t\t\t\tmaxZoom: 21,\r\n\t\t\t\t\tminZoom: 5,\r\n\t\t\t\t}),\r\n\t\t\t\t// 天地卫星图\r\n\t\t\t\tL.tileLayer.chinaProvider('TianDiTu.Satellite.Map', {\r\n\t\t\t\t\tid: 'layer_tiandi',\r\n\t\t\t\t\tdetectRetina: false,\r\n\t\t\t\t\tzIndex: 2,\r\n\t\t\t\t\tmaxZoom: 18,\r\n\t\t\t\t\tminZoom: 5,\r\n\t\t\t\t}),\r\n\t\t\t\t// 高德 2D 地图\r\n\t\t\t\tL.tileLayer.chinaProvider('GaoDe.Normal.Map', {\r\n\t\t\t\t\tid: 'layer_gaodeLabel',\r\n\t\t\t\t\tdetectRetina: false,\r\n\t\t\t\t\tzIndex: 1,\r\n\t\t\t\t\tmaxZoom: 18,\r\n\t\t\t\t\tminZoom: 5,\r\n\t\t\t\t}),\r\n\t\t\t]);\r\n\t\t},\r\n\t\t// 初始化\r\n\t\tasync initLMap() {\r\n\t\t\t// 高德坐标和L坐标数组相反\r\n\t\t\t// const gCenter = await this.getCenter();\r\n\t\t\t// console.log(gCenter);\r\n\t\t\treturn L.map(this.$refs.lMapRef, {\r\n\t\t\t\tcenter: [39.89491, 116.322056],\r\n\t\t\t\tzoom: 7,\r\n\t\t\t\tlayers: this.baseLayerGroup(),\r\n\t\t\t\tzoomControl: false,\r\n\t\t\t\tattributionControl: false,\r\n\t\t\t\tdragging: true,\r\n\t\t\t\ttouchZoom: false,\r\n\t\t\t\tscrollWheelZoom: true,\r\n\t\t\t\tdoubleClickZoom: true,\r\n\t\t\t\tboxZoom: false,\r\n\t\t\t\ttap: false,\r\n\t\t\t\tkeyboard: true,\r\n\t\t\t\tmaxZoom: 21,\r\n\t\t\t\tminZoom: 5,\r\n\t\t\t\tzoomSnap: 0.2,\r\n\t\t\t});\r\n\t\t},\r\n\t\t// 渲染\r\n\t\tasync renderMap() {\r\n\t\t\tthis.baseLayerGroup().addTo((this.mapLayer = await this.initLMap()));\r\n\t\t\t/* this.mapLayer.on('zoomend', ({ target }) => {\r\n        console.log(target._zoom);\r\n      }); */\r\n\t\t},\r\n\t\t// 渲染markers\r\n\t\tasync renderMarkersToMap() {\r\n\t\t\tconst res = await this.getFarmListByArea();\r\n\t\t\t// console.log(res);\r\n\t\t\t// 处理后台数据转换成客户端数据类型\r\n\t\t\tconst farmList = res.list\r\n\t\t\t\t.filter(info => {\r\n\t\t\t\t\treturn info.farmCenterLat && info.farmCenterLng;\r\n\t\t\t\t})\r\n\t\t\t\t.map(({companyId, farmId, farmName, farmCenterLat, farmCenterLng, provinceName, cityName, countyName, provinceId}) => {\r\n\t\t\t\t\t// console.log(provinceId);\r\n\t\t\t\t\t// 直辖市不显示省级\r\n\t\t\t\t\tconst municipalityIds = ['310000', '110000', '120000'];\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tcompanyId,\r\n\t\t\t\t\t\tfarmId,\r\n\t\t\t\t\t\tfarmName,\r\n\t\t\t\t\t\tlatlng: L.latLng(farmCenterLat, farmCenterLng),\r\n\t\t\t\t\t\taddr: [municipalityIds.includes(String(provinceId)) ? null : provinceName, cityName, countyName].filter(v => !!v).join('-'),\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\t\t\t// 聚集的标记点初始化\r\n\t\t\tconst markers = L.markerClusterGroup({\r\n\t\t\t\tshowCoverageOnHover: false,\r\n\t\t\t\tmaxClusterRadius: 20,\r\n\t\t\t\tzoomToBoundsOnClick: false,\r\n\t\t\t\tspiderLegPolylineOptions: {\r\n\t\t\t\t\tstroke: false,\r\n\t\t\t\t\t// color: '#fff'\r\n\t\t\t\t},\r\n\t\t\t\ticonCreateFunction(cluster) {\r\n\t\t\t\t\t// 创建自定的聚集点\r\n\t\t\t\t\tconst childCount = cluster.getChildCount();\r\n\r\n\t\t\t\t\treturn new L.DivIcon({\r\n\t\t\t\t\t\thtml: `<div class=\"marker-icon\">${childCount}</div>`,\r\n\t\t\t\t\t\tclassName: 'marker-cluster-custom',\r\n\t\t\t\t\t\ticonSize: new L.Point(30, 36),\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t\t// 所有农场点绘制的区域\r\n\t\t\tconst farmPolygonArea = L.polygon(\r\n\t\t\t\tfarmList.map(({latlng}) => latlng),\r\n\t\t\t\t{}\r\n\t\t\t).getBounds();\r\n\t\t\t// console.log(L.polygon(farmList.map(({ latlng }) => latlng), {}));\r\n\t\t\tconst _zoom = this.mapLayer.getBoundsZoom(farmPolygonArea);\r\n\t\t\tconst _center = farmPolygonArea.getCenter();\r\n\t\t\tconst defaultIcon = L.icon({\r\n\t\t\t\ticonUrl: require('images/overview/marker-icon.png'),\r\n\t\t\t\ticonSize: [12, 18],\r\n\t\t\t});\r\n\t\t\tconst hoverIcon = L.icon({\r\n\t\t\t\ticonUrl: require('images/overview/marker-icon-hover.png'),\r\n\t\t\t\ticonSize: [12, 18],\r\n\t\t\t});\r\n\t\t\t// 重新设置中心点\r\n\t\t\tthis.mapLayer.setView(_center, _zoom - 1.2);\r\n\t\t\tfarmList.forEach(({latlng, farmName, addr, farmId}) => {\r\n\t\t\t\tconst mk = L.marker(latlng, {\r\n\t\t\t\t\ticon: defaultIcon,\r\n\t\t\t\t});\r\n\t\t\t\tmk.bindTooltip(`<p class=\"b-des\">${farmName}</p><p class=\"s-des\">${addr}</p>`, {\r\n\t\t\t\t\tclassName: 'l-map-tooltip-custom',\r\n\t\t\t\t\topacity: 1,\r\n\t\t\t\t\tdirection: 'top',\r\n\t\t\t\t\tsticky: true,\r\n\t\t\t\t\t// offset: L.point(5, 0)\r\n\t\t\t\t});\r\n\t\t\t\tmk.on('mouseover', e => {\r\n\t\t\t\t\t// console.log(e);\r\n\t\t\t\t\tmk.setIcon(hoverIcon);\r\n\t\t\t\t});\r\n\t\t\t\tmk.on('mouseout', () => {\r\n\t\t\t\t\tmk.setIcon(defaultIcon);\r\n\t\t\t\t});\r\n\t\t\t\tmk.on('click', () => {\r\n\t\t\t\t\t// this.$router.push({ path: `/farmdetail/${farmId}` });\r\n\t\t\t\t\tthis.$router.push({\r\n\t\t\t\t\t\tname: 'farmdetail',\r\n\t\t\t\t\t\tparams: {\r\n\t\t\t\t\t\t\tfarmid: farmId,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmk.setIcon(defaultIcon);\r\n\t\t\t\t\tmk.closeTooltip();\r\n\t\t\t\t});\r\n\t\t\t\tmarkers.addLayer(mk);\r\n\t\t\t});\r\n\t\t\tthis.mapLayer.addLayer(markers);\r\n\t\t\t// 聚集点的事件绑定\r\n\t\t\tmarkers.on('clusterclick', all => {\r\n\t\t\t\tconst markersPolygonArea = all.layer.getBounds();\r\n\t\t\t\tconst _zoom = this.mapLayer.getBoundsZoom(markersPolygonArea);\r\n\t\t\t\tconst _center = markersPolygonArea.getCenter();\r\n\t\t\t\tthis.mapLayer.setView(_center, _zoom - 1.2);\r\n\t\t\t\t// console.log(_zoom, _center);\r\n\t\t\t});\r\n\t\t},\r\n\t},\r\n\twatch: {},\r\n\tcomponents: {\r\n\t\toperatorsList: () => import('./operators-list.vue'),\r\n\t},\r\n};\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n@import '~styles/selectSkin_default';\r\n@import '~styles/overview/map';\r\n/*地块详情弹框*/\r\n/deep/ .el-dialog__wrapper {\r\n\ttop: calc(50vh - 353px);\r\n}\r\n/*当前模块位置部分样式*/\r\n.map-view {\r\n\twidth: 100%;\r\n\theight: 100%;\r\n}\r\n.map-control {\r\n\theight: $moduleheight2;\r\n\tposition: absolute;\r\n\t@include moduleTop(0);\r\n\t@include moduleLeft(1);\r\n}\r\n.gisloader {\r\n\twidth: $modulewidth2;\r\n\theight: $moduleheight2;\r\n\tposition: absolute;\r\n\t@include moduleTop(0);\r\n\t@include moduleLeft(1);\r\n\tz-index: 3;\r\n}\r\n/*当前模块位置部分样式 大屏*/\r\n@media screen and (min-width: 2000px) and (max-width: 3840px) {\r\n\t.map-view {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t}\r\n\t.map-control {\r\n\t\theight: $modulepheight2;\r\n\t\tposition: absolute;\r\n\t\t@include moduleplusTop(0);\r\n\t\t@include moduleplusLeft(2);\r\n\t}\r\n\t.gisloader {\r\n\t\twidth: $modulepwidth2;\r\n\t\theight: $modulepheight2;\r\n\t\tposition: absolute;\r\n\t\t@include moduleplusTop(0);\r\n\t\t@include moduleplusLeft(2);\r\n\t\tz-index: 3;\r\n\t}\r\n}\r\n\r\n.map-area {\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\toverflow: hidden;\r\n\t.map-view {\r\n\t\tposition: relative;\r\n\t\tz-index: 2;\r\n\t\t#gismap {\r\n\t\t\twidth: 100%;\r\n\t\t\theight: calc(133.33%);\r\n\t\t\toverflow: hidden;\r\n\t\t\tposition: absolute;\r\n\t\t\tleft: 0;\r\n\t\t\tbottom: 0;\r\n\t\t\tbackground-color: #061f36;\r\n\t\t\t&:before {\r\n\t\t\t\tcontent: '.';\r\n\t\t\t\tfont-size: 0;\r\n\t\t\t\tdisplay: inline-block;\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\theight: 75.008%;\r\n\t\t\t\tbackground: url('~@/assets/images/gismap/overview-map-bg.png') center no-repeat;\r\n\t\t\t\tbackground-size: 100% 100%;\r\n\t\t\t\tposition: absolute;\r\n\t\t\t\tbottom: 0;\r\n\t\t\t\tleft: 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t.map-control {\r\n\t\tposition: relative;\r\n\t\tz-index: 3;\r\n\t}\r\n}\r\n#gismap {\r\n\t/deep/ .leaflet-map-pane {\r\n\t\t.leaflet-tile-pane {\r\n\t\t\topacity: 0.4;\r\n\t\t}\r\n\t}\r\n}\r\n/* markers custom*/\r\n/deep/ .marker-cluster-custom {\r\n\t/*position: relative;*/\r\n\tbackground: url('~@/assets/images/overview/marker-icon×2.png') no-repeat;\r\n\tbackground-size: 100% 100%;\r\n\t.marker-icon {\r\n\t\twidth: 26px;\r\n\t\theight: 26px;\r\n\t\tborder-radius: 50%;\r\n\t\tbackground: rgba(137, 92, 27, 0.83);\r\n\t\tfont-size: 12px;\r\n\t\tcolor: #ffc400;\r\n\t\ttext-align: center;\r\n\t\tline-height: 26px;\r\n\t\tmargin-top: 2px;\r\n\t\tmargin-left: 2px;\r\n\t}\r\n}\r\n/deep/ .leaflet-tooltip-pane {\r\n\tbackground-color: transparent;\r\n\t.l-map-tooltip-custom {\r\n\t\tbackground-color: #00f6ff;\r\n\t\tborder-radius: 0;\r\n\t\tborder: 0 none;\r\n\t\tposition: relative;\r\n\t\ttop: -12px;\r\n\t\tpadding: 6px 10px;\r\n\t\t/*transition: all 0.5s;*/\r\n\t\t&.leaflet-tooltip-right {\r\n\t\t\tmargin-left: 15px;\r\n\t\t\t&:before {\r\n\t\t\t\tborder-right-color: #00f6ff;\r\n\t\t\t}\r\n\t\t}\r\n\t\t&.leaflet-tooltip-left {\r\n\t\t\t/*margin-right: 15px;*/\r\n\t\t\tright: 10px;\r\n\t\t\t&:before {\r\n\t\t\t\tborder-left-color: #00f6ff;\r\n\t\t\t}\r\n\t\t}\r\n\t\t&.leaflet-tooltip-top {\r\n\t\t\t/*margin-right: 15px;*/\r\n\t\t\t&:before {\r\n\t\t\t\tborder-top-color: #00f6ff;\r\n\t\t\t}\r\n\t\t}\r\n\t\t&.leaflet-tooltip-bottom {\r\n\t\t\t/*margin-right: 15px;*/\r\n\t\t\t&:before {\r\n\t\t\t\tborder-bottom-color: #00f6ff;\r\n\t\t\t}\r\n\t\t}\r\n\t\t.b-des {\r\n\t\t\t/*padding: 0 10px;*/\r\n\t\t\tcolor: #020c20;\r\n\t\t\tfont-size: 14px;\r\n\t\t\tline-height: 20px;\r\n\t\t}\r\n\t\t.s-des {\r\n\t\t\t/*padding: 0 10px;*/\r\n\t\t\tcolor: #099097;\r\n\t\t\tfont-size: 12px;\r\n\t\t\tline-height: 16px;\r\n\t\t}\r\n\t}\r\n}\r\n</style>\r\n\n\n\n// WEBPACK FOOTER //\n// src/components/overview/map/leaflet-map.vue"],"mappings":"AAyBA","sourceRoot":""}